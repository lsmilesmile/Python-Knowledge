# 多线程编程



## 1 - 简介

​	多线程编程对于具有如下特点的编程任务而言是非常理想的：本质上是异步的；需要多 个并发活动；每个活动的处理顺序可能是不确定的，或者说是随机的、不可预测的。这种编 程任务可以被组织或划分成多个执行流，其中每个执行流都有一个指定要完成的任务。根据 应用的不同，这些子任务可能需要计算出中间结果，然后合并为最终的输出结果。    



## 2 - 进程和线程

### 2.1 进程

​	计算机程序只是存储在磁盘上的可执行二进制（或其他类型）文件。只有把它们加载到 内存中并被操作系统调用，才拥有其生命期。 进程（有时称为重量级进程）则是一个执行中 的程序。每个进程都拥有自己的地址空间、内存、数据栈以及其他用于跟踪执行的辅助数据。采用进程间通信（IPC）的方式共享信息。    

### 2.2 线程

​	线程（有时候称为轻量级进程）与进程类似，不过它们是在同一个进程下执行的，并 共享相同的上下文。可以将它们认为是在一个主进程或“主线程”中并行运行的一些“迷 你进程”。 

​	线程包括开始、执行顺序和结束三部分。它有一个指令指针，用于记录当前运行的上下 文。当其他线程运行时，它可以被抢占（中断）和临时挂起（也称为睡眠） ——这种做法叫 做让步。

 	一个进程中的各个线程与主线程共享同一片数据空间，因此相比于独立的进程而言，线 程间的信息共享和通信更加容易。线程一般是以并发方式执行的，正是由于这种并行和数据 共享机制，使得多任务间的协作成为可能。当然，在单核 CPU 系统中，因为真正的并发是不 可能的，所以线程的执行实际上是这样规划的：每个线程运行一小会儿，然后让步给其他线 程（再次排队等待更多的 CPU 时间）。在整个进程的执行过程中，每个线程执行它自己特定 的任务，在必要时和其他线程进行结果通信。 

​	当然，这种共享并不是没有风险的。如果两个或多个线程访问同一片数据，由于数据访 问顺序不同，可能导致结果不一致。这种情况通常称为竞态条件。幸运的是， 大多数线程库都有一些同步原语，以允许线程管理器控制执行和访问。    

### 2.3 线程和Python

​	Python 代码的执行是由 Python 虚拟机（又名解释器主循环）进行控制的。尽管Python 解释器中可以运行多个线程，但是在任意给定时刻只有一个线程会被解释器执行。    

​	对 Python 虚拟机的访问是由全局解释器锁（GIL）控制的。这个锁就是用来保证同时只 能有一个线程运行的。在多线程环境中， Python 虚拟机将按照下面所述的方式执行：

```
1. 设置 GIL。
2. 切换进一个线程去运行。 
3. 执行下面操作之一：
   -  指定数量的字节码指令。 
   - 线程主动让出控制权（可以调用 time.sleep(0)来完成）。
4. 把线程设置回睡眠状态（切换出线程）。 
5. 解锁 GIL。 
6. 重复上述步骤     
```

### 2.4 在Python中使用线程

